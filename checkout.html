<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - The Bharbi Store</title>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js"></script>
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<style>
  /* ...your existing styles here... */
</style>
</head>
<body>
<header>
  <h1>Checkout</h1>
  <a href="cart.html">Back to Cart</a>
</header>
<main>
  <h2>Items in your cart</h2>
  <div id="cart-list"></div>
  <h3>Total: ₦<span id="total-price">0</span></h3>
  <div class="bank-details">
    <h3>Payment Details</h3>
    <p><strong>Bank Name:</strong> UBA</p>
    <p><strong>Account Name:</strong> Itunuoluwa Comfort Femi-Asoro</p>
    <p><strong>Account Number:</strong> 2242094371</p>
  </div>
  <div class="upload-proof">
    <label for="proof">Upload Proof of Payment:</label><br>
    <input type="file" id="proof" accept="image/*">
  </div>
  <button class="done-btn" onclick="sendOrder()">Done</button>
</main>
<script>
  // Firebase setup
  const firebaseConfig = {
    apiKey: "AIzaSyD5-sq8L8Ufbzv4TA7L7iGN2l3QUu7aTqg",
    authDomain: "the-bharbi-store.firebaseapp.com",
    projectId: "the-bharbi-store",
    storageBucket: "the-bharbi-store.firebasestorage.app",
    messagingSenderId: "408548704915",
    appId: "1:408548704915:web:b828a583e55433f9750366"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // EmailJS setup
  emailjs.init("YOUR_EMAILJS_USER_ID"); // <-- Replace with your EmailJS User ID

  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  let total = Number(localStorage.getItem("total")) || 0;

  const cartList = document.getElementById("cart-list");
  const totalPrice = document.getElementById("total-price");
  totalPrice.textContent = total;

  if(cart.length === 0){
    cartList.innerHTML = "<p>Your cart is empty.</p>";
  } else {
    cart.forEach((item)=>{
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <img src="${item.image || 'placeholder.jpg'}" alt="${item.name}">
        <div class="cart-info">
          <h3>${item.name} ×${item.quantity}</h3>
          <p>₦${item.price} each</p>
        </div>
        <p>₦${item.price * item.quantity}</p>
      `;
      cartList.appendChild(div);
    });
  }

  function sendOrder(){
    if(cart.length === 0){
      alert("Cart is empty!");
      return;
    }
    const proofInput = document.getElementById("proof");
    let proofBase64 = "";
    if (proofInput.files.length > 0) {
      const reader = new FileReader();
      reader.onload = function(event) {
        proofBase64 = event.target.result;
        saveOrderToFirestoreAndEmail(proofBase64);
      };
      reader.readAsDataURL(proofInput.files[0]);
    } else {
      saveOrderToFirestoreAndEmail("");
    }
  }

  function saveOrderToFirestoreAndEmail(proofBase64) {
    const user = auth.currentUser;
    // Save to Firestore
    db.collection("orders").add({
      user: user ? user.uid : null,
      cart: cart,
      total: total,
      proof: proofBase64,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      // Prepare order details for email
      const itemsText = cart.map(item => `${item.name} ×${item.quantity} = ₦${item.price * item.quantity}`).join("\n");
      const emailParams = {
        to_email: "tfemiasoro@gmail.com",
        message: `Order Details:\n\n${itemsText}\n\nTotal: ₦${total}\n\nBank Details:\nBank: UBA\nAccount Name: Itunuoluwa Comfort Femi-Asoro\nAccount No: 2242094371\n\nProof: ${proofBase64 ? "Attached" : "None"}`
      };
      // Send via EmailJS
      emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", emailParams)
        .then(()=>{
          alert("Order sent successfully!");
          localStorage.removeItem("cart");
          localStorage.removeItem("total");
          window.location.href = "index.html";
        })
        .catch(err=>{
          alert("Order saved, but failed to send email. Please check your internet and try again.");
        });
    }).catch(err => {
      alert("Failed to send order. Please try again.");
    });
  }
</script>
</body>
</html>
